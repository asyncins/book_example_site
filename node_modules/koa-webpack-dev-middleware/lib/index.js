'use strict';

var expressMiddleware = require('webpack-dev-middleware');

function middleware(doIt, req, res) {
  var originalEnd = res.end;


  return function (done) {
    res.end = function end() {
      originalEnd.apply(this, arguments);
      done(null, 0);
    };
    doIt(req, res, function () {
      done(null, 1);
    });
  };
}

module.exports = function (compiler, option) {
  var doIt = expressMiddleware(compiler, option);

  function* koaMiddleware(next) {
    var ctx = this;
    var req = ctx.req;

    var locals = ctx.locals || ctx.state;

    ctx.webpack = doIt;

    var runNext = yield middleware(doIt, req, {
      end: function end(content) {
        ctx.body = content;
      },

      locals: locals,
      setHeader: function setHeader() {
        ctx.set.apply(ctx, arguments);
      }
    });

    if (runNext) {
      yield* next;
    }
  }

  Object.keys(doIt).forEach(function (p) {
    koaMiddleware[p] = doIt[p];
  });

  return koaMiddleware;
};